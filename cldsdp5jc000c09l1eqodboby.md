# A simple web worker demo with TypeScript and NextJS

## üóª Prerequisites

In this demo, we are using (on 2023-02-06):

* NextJS: 13.1.5

* TypeScript template

* Bundler: Turbopack or webpack

Let's create a simple web worker demo!

## üåª Create a simple web worker demo

Because we [can use Worker on any browser](https://caniuse.com/webworkers), so we don't need to check `if (typeof Worker !== 'undefined')`:

```typescript
if (typeof Worker !== 'undefined') {
  // Create a new Worker.
} else {
  // Web workers are not supported in this environment.
}
```

We need `new URL()` , the project can't detect the real path of `../workers/plus` when source code is built with bundler (e.g. [webpack](https://webpack.js.org/)).

Import webworker script without `new URL()` :

```typescript
const plusWorker = new Worker('../workers/plus');
```

Import webworker script with `new URL()` :

```typescript
const plusWorker = new Worker(new URL('../workers/plus', import.meta.url));
```

I develop with the `next dev --turbo` script. This is [turbopack mode](https://nextjs.org/docs/advanced-features/turbopack) (A webpack alternative). But unfortunately, the following error occurred:

> Refused to execute script from '[http://localhost:3000/\_next/static/assets/d6f517fec7dcd080.ts](http://localhost:3000/_next/static/assets/d6f517fec7dcd080.ts)' because its MIME type ('video/vnd.dlna.mpeg-tts') is not executable.

Then, I back to `webpack` with the `next dev` script, everything works fine! Maybe [vercel turbo](https://github.com/vercel/turbo) is a very new tool and there are still many issues with it at this time.

Here is the complete code. `src/pages/index.tsx` file's content:

```typescript
import Head from 'next/head';
import styles from '@/styles/Home.module.css';
import { useEffect } from 'react';

export default function Home() {
  useEffect(() => {
    const plusWorker = new Worker(new URL('../workers/plus', import.meta.url));

    plusWorker.onmessage = (event) => {
      console.log('üçè Message received from worker: ', event.data);
    };

    plusWorker.onerror = (event) => {
      if (event instanceof Event) {
        console.log('üçé Error message received from worker: ', event);
        return event;
      }

      console.log('üçé Unexpected error: ', event);
      throw event;
    };

    plusWorker.postMessage([1, 2]);

    return () => {
      plusWorker.terminate();
    };
  }, []);

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <div className={styles.description}>
          <p>Get started by editing</p>
        </div>
      </main>
    </>
  );
}
```

`src/workers/plus.ts` file's content:

```typescript
import { TWorkerMess } from '@/models';

const onmessage = (event: MessageEvent<TWorkerMess>) => {
  console.log('üêù Worker: Message received from main script');
  const data = event.data;
  const result = data[0] * data[1];

  const workerResult = 'Result: ' + result;
  console.log('üêù Worker: Posting message back to main script');
  postMessage(workerResult);
};

addEventListener('message', onmessage);
```

`src/models/worker.ts` file's content:

```typescript
export type TWorkerMess = number[];
```

When run `next dev` or `pnpm dev` output on console log is below:

> üêù Worker: Message received from main script
> 
> üêù Worker: Posting message back to main script
> 
> üçè Message received from worker: Result: 2

We did it!

## üçÉ References

* [https://caniuse.com/webworkers](https://caniuse.com/webworkers)
    
* [https://angular.io/guide/web-worker](https://angular.io/guide/web-worker)
    
* [https://stackblitz.com/github/vercel/next.js/tree/canary/examples/with-web-worker?file=utils%2Fpi.ts,package.json](https://stackblitz.com/github/vercel/next.js/tree/canary/examples/with-web-worker?file=utils%2Fpi.ts,package.json)
    
* [https://magland.hashnode.dev/typescript-web-workers-in-react](https://magland.hashnode.dev/typescript-web-workers-in-react)